document.addEventListener("DOMContentLoaded",(function(){fetchCampaignData()}));let countryCounts={};const countryCodeToName={AF:"Afghanistan",AX:"Ã…land Islands",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AQ:"Antarctica",AG:"Antigua and Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia and Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"British Indian Ocean Territory",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos (Keeling) Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CD:"Congo, Democratic Republic of the",CK:"Cook Islands",CR:"Costa Rica",CI:"CÃ´te d'Ivoire",HR:"Croatia",CU:"Cuba",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands (Malvinas)",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Territories",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard Island and McDonald Islands",VA:"Holy See (Vatican City State)",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran",IQ:"Iraq",IE:"Ireland",IM:"Isle of Man",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KP:"North Korea",KR:"South Korea",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Lao People's Democratic Republic",LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"West Bank",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RE:"RÃ©union",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",BL:"Saint BarthÃ©lemy",SH:"Saint Helena, Ascension and Tristan da Cunha",KN:"Saint Kitts and Nevis",LC:"Saint Lucia",MF:"Saint Martin (French part)",PM:"Saint Pierre and Miquelon",VC:"Saint Vincent and the Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome and Principe",SA:"Saudi Arabia",SN:"Senegal",RS:"Serbia",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",GS:"South Georgia and the South Sandwich Islands",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard and Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad and Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks and Caicos Islands",TV:"Tuvalu",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States of America",UM:"United States Minor Outlying Islands",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Viet Nam",VG:"Virgin Islands, British",VI:"Virgin Islands, U.S.",WF:"Wallis and Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"},countryNameToCode=Object.entries(countryCodeToName).reduce(((e,[t,n])=>(e[n]=t,e)),{});function createCampaignDataTable(e){const t=document.createElement("table"),n=document.createElement("table");t.className=n.className="data-table";const a=document.createElement("tr");a.className="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 uppercase text-sm leading-normal",["Event","referrer","IP","Browser","Device","OS","Country","Region","City","Timezone","Language","Timestamp","Data"].forEach((e=>{const t=document.createElement("th");t.textContent=e,a.appendChild(t)})),t.appendChild(a),e.reverse().forEach(((e,t)=>{const a=document.createElement("tr");a.className=t%2==0?"bg-white dark:bg-gray-700":"bg-gray-100 dark:bg-gray-500",a.innerHTML=`\n            <td class="px-4 py-2 whitespace-nowrap">${eventFromPath(e.path)||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${e.referrer||"direct"}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${e.geo?.ip.replace("::ffff:","").replace("::1","localhost")||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${getBrowserIcon(e.useragent?.browser)} ${e.useragent?.browser||""} ${e.useragent?.version||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${getDeviceIcon(e.useragent?.device)} ${e.useragent?.device||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${getOSIcon(e.useragent?.os)} ${e.useragent?.os||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${getCountryFlagIcon(e.geo.country)} ${e.geo.country||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${e.geo.region||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${e.geo.city||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${e.geo.timezone||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${e.language.join(", ")||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${new Date(e.decay).toLocaleString()||""}</td>\n            <td class="px-4 py-2 whitespace-nowrap">${"string"==typeof e.params?Object.entries(JSON.parse(e.params)).map((([e,t])=>`${e}: ${t}`)).join(", "):e.params?Object.entries(e.params).map((([e,t])=>`${e}: ${t}`)).join(", "):""}</td>\n        `,n.appendChild(a)}));const o=document.createElement("div");o.style.visibility="hidden",o.appendChild(n),document.body.appendChild(o);const r=[],i=n.querySelector("tr");return i&&i.childNodes.forEach((e=>{r.push(e.offsetWidth)})),t.querySelector("tr").childNodes.forEach(((e,t)=>{e.style.width=`${r[t]}px`})),document.body.removeChild(o),{headerTable:t,bodyTable:n}}function initMap(){const e=L.map("map",{center:[45,0],zoom:1,zoomControl:!1});getGeoData().then((t=>{L.choropleth(t,{valueProperty:function(e){const t=e.properties.name;return countryCounts[t]||0},scale:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b","#041845","#c6dbef"],steps:10,mode:"q",style:{color:"#cccccc",weight:.5,fillOpacity:.6},onEachFeature:function(e,t){t.bindPopup(e.properties.name+": "+(countryCounts[e.properties.name]||0))}}).addTo(e)}))}function translateCountryCounts(e,t){const n={};for(const[a,o]of Object.entries(e)){const e=t[a];e&&(n[e]=o)}return n}async function getGeoData(){try{const e=await fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json");if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return await e.json()}catch(e){}}function fetchCampaignData(){const e=window.location.pathname.split("/"),t=e[e.length-1],n=document.getElementById("title");n.innerHTML="ðŸŽ¯ "+t.replaceAll("-"," ").replaceAll("_"," ");const a=document.createElement("i");a.className="text-lg fas fa-ellipsis-v absolute top-6 right-6 cursor-pointer",a.addEventListener("click",(function(e){e.stopPropagation(),showDropdownMenu(this,t)})),n.appendChild(a),t&&fetch(`/track/api/campaign/${t}`).then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{displayCampaignData(e)})).catch((e=>{}))}function displayCampaignData(e){generateChart(processDataForChart(e));const t=sortDataByCount(groupData(e,"path")),n=sortDataByCount(groupData(e,"referrer")),a=sortDataByCount(groupData(e,"useragent.device")),o=sortDataByCount(groupData(e,"useragent.browser")),r=sortDataByCount(groupData(e,"useragent.os"));countryCounts=sortDataByCount(groupData(e,"geo.country"));const i={};for(const[e,t]of Object.entries(countryCounts)){const n=countryCodeToName[e]||"Unknown";n&&(i[n]=t)}countryCounts=i;const l=document.getElementById("campaignStatsContainer");if(l){const t=generateCampaignStatsRow(e);l.appendChild(t)}populateList("pathList",t,"Events","Views"),populateList("referrerList",n,"Referrers","Views"),populateList("browserList",o,"Browsers","Views","browser"),populateList("deviceList",a,"Devices","Views","device"),populateList("osList",r,"Operating Systems","Views","os"),populateList("thirdRowSecondContainer",countryCounts,"Countries","Views","country");const{headerTable:s,bodyTable:c}=createCampaignDataTable(e);document.querySelector(".table-header-container").appendChild(s),document.querySelector(".table-body-container").appendChild(c),initMap()}function generateTracking(e){const t=document.createElement("div");t.className="tracking-modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full";t.innerHTML='\n        <div class="modal-content bg-white p-6 mx-auto rounded-lg shadow-lg relative min-w-max top-20">\n            <h2 class="text-xl font-semibold mb-4">Generate Tracking URL and Embed Code</h2>\n\n            \x3c!-- Tracking Method --\x3e\n            <div class="mb-4">\n                <label for="trackingMethod" class="block text-gray-700 text-sm font-bold mb-2">Tracking Method:</label>\n                <select id="trackingMethod" name="trackingMethod" class="bg-white border border-gray-300 text-gray-700 rounded leading-tight outline-none focus:outline-none focus:bg-white focus:border-blue-500 appearance-none">\n                    <option value="image">Image Embed</option>\n                    <option value="link">Link</option>\n                    <option value="form">Form Submission</option>\n                </select>\n            </div>\n\n            \x3c!-- Event Type --\x3e\n            <div class="mb-4" id="eventTypeContainer"></div>\n\n            \x3c!-- Additional Options --\x3e\n            <div class="mb-4" id="additionalOptions"></div>\n\n            \x3c!-- Generated Code --\x3e\n            <div class="mt-4">\n                <p class="text-sm font-bold mb-2">Generated Code:</p>\n                <pre id="generatedCode" class="text-sm bg-gray-100 rounded p-2"></pre>\n            </div>\n\n            <button onclick="closeModal()" class="absolute top-2 right-2 bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Close</button>\n        </div>\n    ',document.body.appendChild(t);document.getElementById("trackingMethod").addEventListener("change",(()=>{updateEventTypeOptions(),updateTrackingInfo(e)})),updateEventTypeOptions(),updateTrackingInfo(e)}function updateEventTypeOptions(){const e=document.getElementById("trackingMethod").value;let t="";t="form"===e?'\n            <label for="formAction" class="block text-gray-700 text-sm font-bold mb-2">Form Action:</label>\n            <select id="formAction" name="formAction" class="bg-white border border-gray-300 text-gray-700 rounded leading-tight outline-none focus:outline-none focus:bg-white focus:border-blue-500 appearance-none">\n                <option value="redirect">Redirect</option>\n                <option value="download">File Download</option>\n            </select>\n        ':"link"===e?'<input type="hidden" id="eventType" value="click" />':'\n            <label for="eventType" class="block text-gray-700 text-sm font-bold mb-2">Event Type:</label>\n            <select id="eventType" name="eventType" class="bg-white border border-gray-300 text-gray-700 rounded leading-tight outline-none focus:outline-none focus:bg-white focus:border-blue-500 appearance-none">\n                <option value="pageview">PageView</option>\n                <option value="email-open">Email-Open</option>\n                <option value="other">Other</option>\n            </select>\n            <input type="text" id="customEventType" name="customEventType" class="hidden mt-3 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter custom event type"/>\n        ',document.getElementById("eventTypeContainer").innerHTML=t;const n=document.getElementById("eventType"),a=document.getElementById("formAction"),o=window.location.pathname.split("/"),r=o[o.length-1];n&&n.addEventListener("change",(()=>{updateAdditionalOptions(),updateTrackingInfo(r)})),a&&a.addEventListener("change",updateAdditionalOptions),updateAdditionalOptions()}function updateAdditionalOptions(){const e=document.getElementById("trackingMethod").value,t=document.getElementById("formAction")?document.getElementById("formAction").value:"",n=document.getElementById("additionalOptions");let a="";const o=getCampaignIdFromUrl();if("link"===e)a='\n            <label for="redirectUrl" class="block text-gray-700 text-sm font-bold mb-2">Redirect URL:</label>\n            <input type="text" id="redirectUrl" name="redirectUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter redirect URL (ex. https://google.com)"/>\n        ',n.innerHTML=a,document.getElementById("redirectUrl").addEventListener("input",(()=>updateTrackingInfo(o)));else if("form"===e){"redirect"===t?a='\n                <label for="redirectUrl" class="block text-gray-700 text-sm font-bold mb-2">Redirect URL:</label>\n                <input type="text" id="redirectUrl" name="redirectUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter redirect URL (ex. https://google.com)"/>\n            ':"download"===t&&(a='\n                <label for="fileDownloadPath" class="block text-gray-700 text-sm font-bold mb-2">File Download Path:</label>\n                <input type="text" id="fileDownloadPath" name="fileDownloadPath" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter file download path (ex. https://file-examples.com/wp-content/storage/2017/10/file-sample_150kB.pdf)"/>\n            '),n.innerHTML=a;const e=document.getElementById("redirectUrl"),r=document.getElementById("fileDownloadPath"),i=document.getElementById("formAction");e&&e.addEventListener("input",(()=>updateTrackingInfo(o))),r&&r.addEventListener("input",(()=>updateTrackingInfo(o))),i&&i.addEventListener("input",(()=>updateTrackingInfo(o)))}else n.innerHTML=""}function getCampaignIdFromUrl(){const e=window.location.pathname.split("/");return e[e.length-1]}function updateTrackingInfo(e){const t=window.location.protocol+"//"+window.location.host,n=document.getElementById("trackingMethod").value,a=document.getElementById("eventType")?document.getElementById("eventType").value:"",o=document.getElementById("customEventType")?document.getElementById("customEventType").value:"",r=document.getElementById("redirectUrl")?document.getElementById("redirectUrl").value:"",i=document.getElementById("fileDownloadPath")?document.getElementById("fileDownloadPath").value:"",l=document.getElementById("formAction")?document.getElementById("formAction").value:"";let s="other"===a&&o?o:a,c=`${t}/track/${s}.gif?campaignID=${e}`,d=`${t}/track/${s}?campaignID=${e}&redirectURL=${encodeURIComponent(r)}`,u="";"image"===n?u=`<img src="${c}" alt="NanoTrack" />`:"link"===n?u=`<a href="${d}">Click here</a>`:"form"===n&&(u=`<form action="${t}/track/${"download"===l?"formDownload":"formRedirect"}?campaignID=${e}" method="post">\n            <input type="hidden" name="campaignID" value="${e}">`,"redirect"===document.getElementById("formAction").value?u+=`<input type="hidden" name="redirectUrl" value="${r}">`:"download"===document.getElementById("formAction").value&&(u+=`<input type="hidden" name="fileDownloadPath" value="${i}">`),u+=`\n            \x3c!-- Add other form fields here --\x3e\n            <button type="submit"${"download"===l?' formtarget="_blank"':""}>Submit</button>\n        </form>`),document.getElementById("generatedCode").innerHTML=escapeHtml(u)}function escapeHtml(e){return e.replaceAll("<strong>","((strong))").replaceAll("</strong>","((/strong))").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replaceAll("((strong))","<strong>").replaceAll("((/strong))","</strong>")}function closeModal(){const e=document.querySelector(".tracking-modal");e&&e.remove()}function showDropdownMenu(e,t){closeAllDropdowns();const n=document.createElement("div");n.className="dropdown-menu text-sm font-normal rounded",n.innerHTML=`\n        <ul>\n            <li class="dropdown-item" onclick="generateTracking('${t}')">Generate Tracking Image</li>\n            <li class="dropdown-item" onclick="deleteCampaign('${t}')">Delete Campaign & Data</li>\n        </ul>\n    `,n.style.position="absolute",n.style.top=`${e.offsetTop+e.offsetHeight}px`,n.style.right="10px";e.parentElement.appendChild(n),document.addEventListener("click",closeAllDropdowns)}function closeAllDropdowns(){document.querySelectorAll(".dropdown-menu").forEach((e=>{e.remove()}))}function deleteCampaign(e){confirm("Are you sure? This will delete all existing tracking data for this campaign and cannot be undone.")&&fetch(`/track/api/campaign/${e}`,{method:"DELETE"}).then((e=>e.json())).then((e=>{location.replace("/campaigns")})).catch((e=>{}))}function processDataForChart(e){const t={};return e.forEach((e=>{new Date(e.decay).getHours();const n=new Date(e.decay);n.setMinutes(0),n.setSeconds(0),n.setMilliseconds(0);const a=n.toLocaleString();t[a]||(t[a]=0),t[a]++})),t}function generateChart(e){const t=document.getElementById("eventsChart").getContext("2d"),n=Object.keys(e),a=Object.values(e);new Chart(t,{type:"line",data:{labels:n,datasets:[{label:"Events per Hour",data:a,backgroundColor:"#BFDBFE",borderColor:"#BFDBFE",borderWidth:1}]},options:{scales:{y:{beginAtZero:!0}}}})}function generateCampaignStatsRow(e){const t=e.length,n=new Set(e.map((e=>e.geo.ip))).size,a=new Set(e.map((e=>e.referrer))).size,o=new Set(e.map((e=>e.path))).size,r=new Set(e.map((e=>e.geo.country))).size,i=new Set(e.map((e=>e.geo.timezone))).size,l=document.createElement("div");l.className="flex justify-around m-2 mt-3";return[{value:t,label:"Views"},{value:n,label:"IPs"},{value:a,label:"Referrers"},{value:o,label:"Events"},{value:r,label:"Countries"},{value:i,label:"Time Zones"}].forEach((e=>{const t=document.createElement("div");t.className="inline-flex flex-col items-center justify-center w-1/6 p-4",t.innerHTML=`<span class="text-xl xl:text-3xl font-bold">${e.value}</span><label class="text-sm xl:text-lg font-medium">${e.label}</label>`,l.appendChild(t)})),l}function sortDataByCount(e){const t=Object.entries(e);return t.sort(((e,t)=>t[1]-e[1])),t.reduce(((e,[t,n])=>(e[t]=n,e)),{})}function groupData(e,t){const n={};return e.forEach((e=>{let a=e[t];if(t.includes(".")){const n=t.split(".");a=e[n[0]]?e[n[0]][n[1]]:null}else a=e[t];"useragent.os"===t&&("osx"!==a.toLowerCase()&&"os x el capitan"!==a.toLowerCase()||(a="OS X")),"referrer"!==t||a||(a="direct"),"path"===t&&(a=a.replaceAll(".gif","").replaceAll("/","")),a=a||"Unknown",n[a]=(n[a]||0)+1})),n}function populateList(e,t,n,a,o){const r=document.getElementById(e),i=Object.values(t).reduce(((e,t)=>e+t),0);let l=`<table class="data-table"><thead><tr><th>${n}</th><th>${a}</th></tr></thead><tbody>`;for(const[e,n]of Object.entries(t)){const t=Math.floor((n/i*100).toFixed(2));let a="";switch(o){case"browser":a=getBrowserIcon(e);break;case"device":a=getDeviceIcon(e);break;case"os":a=getOSIcon(e);break;case"country":a=getCountryFlagIcon(countryNameToCode[e]||"Unknown")}const r=`${a} ${e}`;let s,c;t<100?(s=Math.max(0,parseFloat(t)),c=Math.min(100,parseFloat(t+5))):(s=100,c=100);l+=`<tr><td class="capitalize">${r}</td><td class="${`bg-gradient-to-r from-blue-100 dark:from-gray-600 from-${5*Math.ceil(s/5)}% to-white dark:to-gray-900 to-${5*Math.ceil(c/5)}%`}"><strong>${n}</strong> | ${t}%</td></tr>`}l+="</tbody></table>",r.innerHTML=l}